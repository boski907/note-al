<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Notematica AI</title>
<style>
  :root {
    --bg:#1a1a2e;--bg2:#16213e;--surface:#1e1e3a;--surface2:#252545;--surface3:#2d2d55;
    --accent:#7c6af7;--accent2:#9c8fff;--accent-glow:rgba(124,106,247,0.18);
    --text:#e8e8f0;--text2:#a0a0c0;--text3:#6060a0;
    --border:#2d2d55;--border2:#3d3d70;--success:#4caf89;--danger:#e05a6b;
    --radius:12px;--radius-sm:8px;--shadow:0 4px 24px rgba(0,0,0,0.4);
    --font:'Segoe UI',system-ui,-apple-system,sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:var(--font);background:var(--bg);color:var(--text);height:100vh;display:flex;overflow:hidden;font-size:14px;}

  /* Sidebar */
  #sidebar{width:240px;min-width:240px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
  .sidebar-logo{padding:18px 16px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
  .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),#a78bfa);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;}
  .logo-text{font-size:16px;font-weight:700;letter-spacing:-.3px;}
  .sidebar-section-label{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);padding:14px 16px 6px;}
  #notebook-list{flex:0 0 auto;overflow-y:auto;max-height:220px;}
  #source-panel{flex:1;display:flex;flex-direction:column;overflow:hidden;border-top:1px solid var(--border);}
  #source-list{flex:1;overflow-y:auto;padding-bottom:8px;}
  .nb-item{display:flex;align-items:center;gap:8px;padding:8px 16px;cursor:pointer;transition:background .15s;position:relative;}
  .nb-item:hover{background:var(--surface);}
  .nb-item.active{background:var(--accent-glow);color:var(--accent2);}
  .nb-item.active::before{content:'';position:absolute;left:0;top:4px;bottom:4px;width:3px;background:var(--accent);border-radius:0 2px 2px 0;}
  .nb-item .nb-icon{font-size:15px;}.nb-item .nb-name{flex:1;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .nb-item .nb-badge{font-size:10px;background:var(--surface3);color:var(--text3);padding:1px 6px;border-radius:10px;}
  .src-item{display:flex;align-items:center;gap:8px;padding:7px 12px 7px 16px;cursor:pointer;transition:background .15s;}
  .src-item:hover{background:var(--surface);}
  .src-icon{font-size:15px;min-width:20px;text-align:center;}
  .src-name{flex:1;font-size:12.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text2);}
  .src-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 4px;opacity:0;transition:opacity .15s;}
  .src-item:hover .src-del{opacity:1;}
  .add-source-btn{margin:8px 12px;padding:8px 12px;background:var(--surface);border:1px dashed var(--border2);border-radius:var(--radius-sm);color:var(--text3);cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px;transition:all .15s;}
  .add-source-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-glow);}

  /* Main */
  #main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg);}
  #topbar{height:52px;min-height:52px;padding:0 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);background:var(--bg2);}
  #topbar h2{font-size:15px;font-weight:600;flex:1;}
  #current-user{font-size:12px;color:var(--text3);padding:0 4px;display:none;}
  .topbar-btn{padding:6px 12px;border-radius:var(--radius-sm);background:var(--surface);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:12.5px;display:flex;align-items:center;gap:5px;transition:all .15s;}
  .topbar-btn:hover{background:var(--surface2);color:var(--text);}
  .topbar-btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
  .topbar-btn.primary:hover{background:var(--accent2);}
  #source-badge-row{display:flex;gap:6px;align-items:center;padding:0 20px;height:36px;min-height:36px;border-bottom:1px solid var(--border);background:var(--bg2);overflow:hidden;}
  .src-badge{display:inline-flex;align-items:center;gap:5px;font-size:11.5px;padding:3px 9px;background:var(--surface);border-radius:20px;color:var(--text2);white-space:nowrap;border:1px solid var(--border);}
  .src-badge.all{background:var(--accent-glow);border-color:var(--accent);color:var(--accent2);}

  /* Chat */
  #chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth;}
  .msg-row{display:flex;gap:10px;max-width:760px;width:100%;}
  .msg-row.user{align-self:flex-end;flex-direction:row-reverse;}
  .msg-row.ai{align-self:flex-start;}
  .msg-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
  .msg-row.user .msg-avatar{background:var(--accent);}
  .msg-row.ai .msg-avatar{background:var(--surface3);}
  .msg-bubble{padding:11px 15px;border-radius:var(--radius);max-width:640px;line-height:1.6;font-size:13.5px;}
  .msg-row.user .msg-bubble{background:var(--accent);color:#fff;border-radius:var(--radius) 4px var(--radius) var(--radius);}
  .msg-row.ai .msg-bubble{background:var(--surface);border:1px solid var(--border);border-radius:4px var(--radius) var(--radius) var(--radius);}
  .msg-bubble p{margin-bottom:8px;}.msg-bubble p:last-child{margin-bottom:0;}
  .msg-bubble strong{color:var(--accent2);}
  .msg-bubble code{background:var(--bg);padding:1px 5px;border-radius:4px;font-size:12px;color:#c3b1e1;}
  .msg-bubble pre{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;overflow-x:auto;margin:8px 0;}
  .msg-bubble pre code{padding:0;background:none;}
  .msg-bubble ul,.msg-bubble ol{padding-left:18px;margin:6px 0;}
  .msg-bubble li{margin-bottom:4px;}
  .msg-time{font-size:10.5px;color:var(--text3);margin-top:4px;padding:0 4px;}
  .typing-indicator{display:flex;align-items:center;gap:5px;padding:11px 15px;background:var(--surface);border:1px solid var(--border);border-radius:4px var(--radius) var(--radius) var(--radius);}
  .typing-dot{width:7px;height:7px;border-radius:50%;background:var(--text3);animation:bounce 1.2s ease-in-out infinite;}
  .typing-dot:nth-child(2){animation-delay:.2s;}.typing-dot:nth-child(3){animation-delay:.4s;}
  @keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.4;}30%{transform:translateY(-6px);opacity:1;}}

  /* Input */
  #chat-input-area{padding:16px 20px;border-top:1px solid var(--border);background:var(--bg2);}
  #input-box{display:flex;gap:10px;align-items:flex-end;background:var(--surface);border:1px solid var(--border2);border-radius:var(--radius);padding:10px 12px;transition:border-color .2s;}
  #input-box:focus-within{border-color:var(--accent);}
  #chat-input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:13.5px;resize:none;font-family:var(--font);max-height:140px;min-height:22px;line-height:1.5;}
  #chat-input::placeholder{color:var(--text3);}
  #send-btn{width:34px;height:34px;border-radius:8px;background:var(--accent);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s;flex-shrink:0;}
  #send-btn:hover{background:var(--accent2);transform:scale(1.05);}
  #send-btn:disabled{background:var(--surface3);color:var(--text3);cursor:not-allowed;transform:none;}
  .input-hint{font-size:11px;color:var(--text3);margin-top:6px;padding-left:2px;}
  #suggestions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
  .suggestion-chip{padding:6px 12px;border-radius:20px;background:var(--surface);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-size:12px;transition:all .15s;}
  .suggestion-chip:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-glow);}

  /* Studio */
  #studio{width:280px;min-width:280px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
  .studio-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 4px;}
  .studio-tab{flex:1;padding:12px 8px;text-align:center;font-size:12.5px;font-weight:500;cursor:pointer;color:var(--text3);border-bottom:2px solid transparent;transition:all .15s;}
  .studio-tab:hover{color:var(--text2);}
  .studio-tab.active{color:var(--accent2);border-bottom-color:var(--accent);}
  .studio-content{flex:1;overflow-y:auto;padding:14px;}
  .studio-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px;cursor:pointer;transition:all .15s;}
  .studio-card:hover{border-color:var(--border2);background:var(--surface2);}
  .studio-card h4{font-size:12.5px;font-weight:600;margin-bottom:5px;}
  .studio-card p{font-size:12px;color:var(--text2);line-height:1.5;}
  .studio-card .card-icon{font-size:20px;margin-bottom:8px;display:block;}
  .note-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:8px;}
  .note-item .note-title{font-size:12.5px;font-weight:600;margin-bottom:4px;}
  .note-item .note-body{font-size:12px;color:var(--text2);line-height:1.5;}
  .note-item .note-meta{font-size:10.5px;color:var(--text3);margin-top:6px;}
  .note-item .note-del{float:right;background:none;border:none;color:var(--text3);cursor:pointer;font-size:13px;}
  .add-note-btn{width:100%;padding:8px;border:1px dashed var(--border2);background:transparent;border-radius:var(--radius-sm);color:var(--text3);cursor:pointer;font-size:12px;transition:all .15s;margin-top:4px;}
  .add-note-btn:hover{border-color:var(--accent);color:var(--accent);}

  /* Modal */
  .modal-overlay{display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.7);align-items:center;justify-content:center;}
  .modal-overlay.open{display:flex;}
  .modal-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:24px;width:520px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);}
  .modal-box h3{font-size:16px;margin-bottom:16px;}
  .drop-zone{border:2px dashed var(--border2);border-radius:var(--radius);padding:28px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:12px;}
  .drop-zone:hover,.drop-zone.dragover{border-color:var(--accent);background:var(--accent-glow);}
  .drop-zone .dz-icon{font-size:32px;display:block;margin-bottom:8px;}
  .drop-zone p{font-size:13px;color:var(--text2);}
  .drop-zone small{font-size:11.5px;color:var(--text3);}
  .modal-tabs{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
  .modal-tab{padding:6px 14px;border-radius:20px;cursor:pointer;font-size:12.5px;border:1px solid var(--border);color:var(--text2);transition:all .15s;}
  .modal-tab.active{background:var(--accent);border-color:var(--accent);color:#fff;}
  .modal-input{width:100%;padding:10px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px;outline:none;margin-bottom:12px;font-family:var(--font);}
  .modal-input:focus{border-color:var(--accent);}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;}
  .modal-btn{padding:8px 16px;border-radius:var(--radius-sm);font-size:13px;cursor:pointer;border:1px solid var(--border);transition:all .15s;}
  .modal-btn.cancel{background:var(--surface);color:var(--text2);}
  .modal-btn.cancel:hover{background:var(--surface2);}
  .modal-btn.confirm{background:var(--accent);border-color:var(--accent);color:#fff;}
  .modal-btn.confirm:hover{background:var(--accent2);}
  .modal-btn:disabled{opacity:.5;cursor:not-allowed;}

  /* Audio/Video */
  .transcript-box{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;min-height:80px;max-height:140px;overflow-y:auto;font-size:12.5px;color:var(--text2);line-height:1.6;margin-bottom:12px;white-space:pre-wrap;}
  .transcript-box.empty{color:var(--text3);font-style:italic;}
  .mic-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:11px;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;border:2px solid var(--border2);background:var(--surface);color:var(--text2);transition:all .2s;}
  .mic-btn:hover{border-color:var(--accent);color:var(--accent);}
  .mic-btn.recording{border-color:var(--danger);color:var(--danger);background:rgba(224,90,107,.1);animation:pulse-border 1.2s ease-in-out infinite;}
  @keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(224,90,107,.4);}50%{box-shadow:0 0 0 6px rgba(224,90,107,0);}}
  .waveform{display:flex;align-items:center;gap:3px;height:20px;}
  .waveform-bar{width:3px;border-radius:2px;background:var(--danger);animation:wave .8s ease-in-out infinite;}
  .waveform-bar:nth-child(1){animation-delay:0s;}.waveform-bar:nth-child(2){animation-delay:.1s;}.waveform-bar:nth-child(3){animation-delay:.2s;}.waveform-bar:nth-child(4){animation-delay:.3s;}.waveform-bar:nth-child(5){animation-delay:.2s;}.waveform-bar:nth-child(6){animation-delay:.1s;}
  @keyframes wave{0%,100%{height:4px;}50%{height:18px;}}
  .divider-label{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text3);margin:10px 0;}
  .divider-label::before,.divider-label::after{content:'';flex:1;height:1px;background:var(--border);}
  .yt-preview{display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:12px;}
  .yt-thumb{width:80px;height:48px;border-radius:6px;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;overflow:hidden;}
  .yt-thumb img{width:100%;height:100%;object-fit:cover;}
  .yt-info{flex:1;min-width:0;}
  .yt-title{font-size:12.5px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .yt-meta{font-size:11px;color:var(--text3);margin-top:2px;}
  .processing-bar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;margin-bottom:10px;}
  .processing-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;animation:progress 1.8s ease-in-out infinite;}
  @keyframes progress{0%{width:0%;margin-left:0;}50%{width:70%;margin-left:15%;}100%{width:0%;margin-left:100%;}}
  .file-info-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;}

  /* Status banner */
  #status-banner{padding:6px 20px;font-size:12px;display:none;align-items:center;gap:8px;}
  #status-banner.error{display:flex;background:rgba(224,90,107,.15);color:var(--danger);border-bottom:1px solid rgba(224,90,107,.3);}
  #status-banner.warn{display:flex;background:rgba(255,180,0,.1);color:#fbbf24;border-bottom:1px solid rgba(255,180,0,.2);}

  /* Empty state */
  #empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text3);}
  #empty-state .es-icon{font-size:48px;}
  #empty-state h3{font-size:18px;color:var(--text2);}
  #empty-state p{font-size:13px;max-width:320px;text-align:center;line-height:1.6;}

  /* Mind map SVG */
  #mind-map-area svg text{fill:var(--text2);}

  ::-webkit-scrollbar{width:5px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:10px;}
  #toast{position:fixed;bottom:24px;right:24px;background:var(--surface3);color:var(--text);padding:10px 16px;border-radius:var(--radius-sm);font-size:13px;box-shadow:var(--shadow);transform:translateY(60px);opacity:0;transition:all .3s;z-index:200;}
  #toast.show{transform:translateY(0);opacity:1;}
  #toast.error-toast{background:rgba(224,90,107,.9);}
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üìì</div>
    <span class="logo-text">Notematica AI</span>
  </div>
  <div class="sidebar-section-label">Notebooks</div>
  <div id="notebook-list"></div>
  <button class="add-source-btn" style="margin:6px 12px 0;" onclick="openNbModal()">Ôºã New notebook</button>
  <div id="source-panel">
    <div class="sidebar-section-label">Sources</div>
    <div id="source-list"></div>
    <button class="add-source-btn" onclick="openUploadModal()">Ôºã Add source</button>
  </div>
</div>

<!-- Main -->
<div id="main">
  <div id="topbar">
    <h2 id="nb-title">Loading‚Ä¶</h2>
    <button class="topbar-btn" onclick="openUploadModal()">üìé Add source</button>
    <button class="topbar-btn primary" onclick="useSuggestion('Summarize all sources in one paragraph')">‚ú® Auto-summarize</button>
    <span id="current-user"></span>
    <button class="topbar-btn" id="logout-btn" onclick="logout()" style="display:none;">Logout</button>
  </div>
  <div id="status-banner"></div>
  <div id="source-badge-row">
    <span class="src-badge all">üóÇ All sources</span>
    <span id="badge-area"></span>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input-area">
    <div id="suggestions"></div>
    <div id="input-box">
      <textarea id="chat-input" placeholder="Ask a question about your sources‚Ä¶" rows="1"></textarea>
      <button id="send-btn" onclick="sendMessage()">‚Üë</button>
    </div>
    <div class="input-hint">Enter to send ¬∑ Shift+Enter for new line</div>
  </div>
</div>

<!-- Studio -->
<div id="studio">
  <div class="studio-tabs">
    <div class="studio-tab active" onclick="switchStudioTab('studio',this)">Studio</div>
    <div class="studio-tab" onclick="switchStudioTab('notes',this)">Notes</div>
    <div class="studio-tab" onclick="switchStudioTab('mind',this)">Mind Map</div>
    <div class="studio-tab" onclick="switchStudioTab('profiles',this)">Profiles</div>
  </div>
  <div class="studio-content" id="studio-content"></div>
</div>

<!-- Upload Modal -->
<div id="upload-modal" class="modal-overlay">
  <div class="modal-box">
    <h3>Add a source</h3>
    <div class="modal-tabs">
      <div class="modal-tab active" onclick="switchUploadTab('file',this)">üìÑ File</div>
      <div class="modal-tab" onclick="switchUploadTab('url',this)">üîó URL</div>
      <div class="modal-tab" onclick="switchUploadTab('text',this)">‚úèÔ∏è Text</div>
      <div class="modal-tab" onclick="switchUploadTab('audio',this)">üé§ Audio</div>
      <div class="modal-tab" onclick="switchUploadTab('video',this)">üé¨ Video</div>
    </div>

    <!-- File -->
    <div id="upload-file-panel">
      <div class="drop-zone" onclick="document.getElementById('file-input').click()"
        ondragover="event.preventDefault();this.classList.add('dragover')"
        ondragleave="this.classList.remove('dragover')"
        ondrop="handleFileDrop(event,'doc')">
        <span class="dz-icon">üìÇ</span>
        <p>Drag & drop or <strong>click to browse</strong></p>
        <small>PDF, TXT, DOCX, MD supported</small>
      </div>
      <input type="file" id="file-input" style="display:none" multiple accept=".pdf,.txt,.docx,.md,.csv" onchange="handleDocFileSelect(event)">
    </div>

    <!-- URL -->
    <div id="upload-url-panel" style="display:none">
      <input type="text" class="modal-input" id="url-input" placeholder="https://example.com/article">
      <div style="font-size:12px;color:var(--text3);">The page will be fetched and its text indexed as a source.</div>
    </div>

    <!-- Text -->
    <div id="upload-text-panel" style="display:none">
      <textarea class="modal-input" id="text-input" rows="5" placeholder="Paste or type your text here‚Ä¶" style="resize:vertical;"></textarea>
      <input type="text" class="modal-input" id="text-name-input" placeholder="Source name (optional)">
    </div>

    <!-- Audio -->
    <div id="upload-audio-panel" style="display:none">
      <div class="drop-zone" onclick="document.getElementById('audio-file-input').click()"
        ondragover="event.preventDefault();this.classList.add('dragover')"
        ondragleave="this.classList.remove('dragover')"
        ondrop="handleFileDrop(event,'audio')">
        <span class="dz-icon">üéµ</span>
        <p>Drop audio file or <strong>click to browse</strong></p>
        <small>MP3, WAV, M4A, OGG, FLAC, AAC ‚Äî transcribed via Whisper</small>
      </div>
      <input type="file" id="audio-file-input" style="display:none" accept=".mp3,.wav,.m4a,.ogg,.flac,.aac,audio/*" onchange="handleAudioFileSelect(event)">
      <div id="audio-file-info" style="display:none">
        <div class="file-info-row">
          <span style="font-size:20px;">üéµ</span>
          <div style="flex:1;min-width:0;">
            <div id="audio-file-name" style="font-size:12.5px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
            <div id="audio-file-size" style="font-size:11px;color:var(--text3);"></div>
          </div>
          <button onclick="clearAudioFile()" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;">‚úï</button>
        </div>
        <div id="audio-processing" style="display:none;">
          <div style="font-size:11.5px;color:var(--text3);margin-bottom:6px;">Transcribing with Whisper‚Ä¶</div>
          <div class="processing-bar"><div class="processing-bar-fill"></div></div>
        </div>
      </div>
      <div class="divider-label">or use live microphone</div>
      <button class="mic-btn" id="mic-btn" onclick="toggleLiveTranscript()">
        <span id="mic-icon">üé§</span><span id="mic-label">Start Live Transcript</span>
      </button>
      <div id="live-transcript-box" style="margin-top:10px;display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div style="font-size:11.5px;color:var(--text3);">Live transcript</div>
          <div id="mic-waveform" class="waveform" style="display:none;">
            <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
            <div class="waveform-bar"></div><div class="waveform-bar"></div><div class="waveform-bar"></div>
          </div>
        </div>
        <div class="transcript-box empty" id="transcript-output">Transcript will appear here as you speak‚Ä¶</div>
        <input type="text" class="modal-input" id="audio-name-input" placeholder="Source name (e.g. Meeting recording)" style="margin-top:0;">
      </div>
    </div>

    <!-- Video -->
    <div id="upload-video-panel" style="display:none">
      <div style="margin-bottom:4px;">
        <div style="font-size:12px;color:var(--text3);margin-bottom:6px;">YouTube URL</div>
        <input type="text" class="modal-input" id="yt-url-input" placeholder="https://youtube.com/watch?v=‚Ä¶" style="margin:0;" oninput="previewYouTube(this.value)">
      </div>
      <div id="yt-preview-box" style="display:none;margin:10px 0;">
        <div class="yt-preview">
          <div class="yt-thumb" id="yt-thumb">‚ñ∂</div>
          <div class="yt-info">
            <div class="yt-title">YouTube Video</div>
            <div class="yt-meta" id="yt-meta">Captions will be extracted automatically</div>
          </div>
        </div>
        <div id="yt-processing" style="display:none;">
          <div style="font-size:11.5px;color:var(--text3);margin-bottom:6px;">Extracting transcript‚Ä¶</div>
          <div class="processing-bar"><div class="processing-bar-fill"></div></div>
        </div>
      </div>
      <div class="divider-label">or upload a video file</div>
      <div class="drop-zone" onclick="document.getElementById('video-file-input').click()"
        ondragover="event.preventDefault();this.classList.add('dragover')"
        ondragleave="this.classList.remove('dragover')"
        ondrop="handleFileDrop(event,'video')">
        <span class="dz-icon">üé¨</span>
        <p>Drop video file or <strong>click to browse</strong></p>
        <small>MP4, MOV, WEBM, AVI, MKV ‚Äî audio track transcribed via Whisper</small>
      </div>
      <input type="file" id="video-file-input" style="display:none" accept=".mp4,.mov,.webm,.avi,.mkv,video/*" onchange="handleVideoFileSelect(event)">
      <div id="video-file-info" style="display:none">
        <div class="file-info-row">
          <span style="font-size:20px;">üé¨</span>
          <div style="flex:1;min-width:0;">
            <div id="video-file-name" style="font-size:12.5px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
            <div id="video-file-size" style="font-size:11px;color:var(--text3);"></div>
          </div>
          <button onclick="clearVideoFile()" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;">‚úï</button>
        </div>
        <div id="video-processing" style="display:none;">
          <div style="font-size:11.5px;color:var(--text3);margin-bottom:6px;">Extracting audio & transcribing‚Ä¶</div>
          <div class="processing-bar"><div class="processing-bar-fill"></div></div>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeUploadModal()">Cancel</button>
      <button class="modal-btn confirm" id="add-source-confirm-btn" onclick="confirmUpload()">Add source</button>
    </div>
  </div>
</div>

<!-- New Notebook Modal -->
<div id="nb-modal" class="modal-overlay">
  <div class="modal-box" style="width:380px;">
    <h3>New Notebook</h3>
    <input type="text" class="modal-input" id="nb-name-input" placeholder="Notebook title‚Ä¶" style="margin-top:12px;">
    <div class="modal-actions" style="margin-top:4px;">
      <button class="modal-btn cancel" onclick="closeNbModal()">Cancel</button>
      <button class="modal-btn confirm" onclick="confirmNewNb()">Create</button>
    </div>
  </div>
</div>

<!-- Auth Modal -->
<div id="auth-modal" class="modal-overlay open">
  <div class="modal-box" style="width:380px;">
    <h3 id="auth-title">Sign in</h3>
    <div id="auth-subtitle" style="font-size:12px;color:var(--text3);margin-bottom:12px;">Enter your credentials to continue.</div>
    <input type="text" class="modal-input" id="auth-username" placeholder="Username">
    <input type="password" class="modal-input" id="auth-password" placeholder="Password">
    <button class="modal-btn confirm" style="width:100%;" id="auth-submit-btn" onclick="submitAuth()">Sign in</button>
    <div id="auth-error" style="min-height:16px;margin-top:10px;font-size:12px;color:var(--danger);"></div>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeNbId = null;
let notebooks = [];
let sources = [];
let messages = [];
let notesList = [];
let profiles = [];
let uploadTab = 'file';
let studioTab = 'studio';
let isRecording = false;
let recognition = null;
let liveTranscriptText = '';
let pendingAudioFile = null;
let pendingVideoFile = null;
let authToken = localStorage.getItem('notematica_auth_token') || '';
let currentProfile = null;
let authMode = 'login';

const API = ''; // same-origin

const SUGGESTIONS = [
  'Summarize all sources in one paragraph',
  'What are the key arguments?',
  'Find contradictions across sources',
  'Generate 5 discussion questions',
  'What are the main conclusions?'
];

// ‚îÄ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(method, path, body, opts = {}) {
  const fetchOpts = { method, headers: {} };
  if (authToken) fetchOpts.headers.Authorization = `Bearer ${authToken}`;
  if (body && !(body instanceof FormData)) {
    fetchOpts.headers['Content-Type'] = 'application/json';
    fetchOpts.body = JSON.stringify(body);
  } else if (body) {
    fetchOpts.body = body;
  }
  const r = await fetch(API + path, fetchOpts);
  const data = await r.json().catch(() => ({}));
  if (!r.ok) {
    if (r.status === 401 && !opts.skipAuthRedirect) {
      clearAuth();
      openAuthModal('login', 'Session expired. Sign in again.');
    }
    throw new Error(data.error || `HTTP ${r.status}`);
  }
  return data;
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  try {
    const health = await api('GET', '/api/health');
    if (health.openai !== 'configured') {
      showBanner('warn', '‚ö†Ô∏è OpenAI API key not configured ‚Äî copy .env.example to .env and add your key, then restart the server.');
    }
  } catch { /* server might not be up yet */ }

  const authed = await ensureAuth();
  if (authed) await Promise.all([loadNotebooks(), loadProfiles()]);
}

function setAuthToken(token) {
  authToken = token || '';
  if (authToken) localStorage.setItem('notematica_auth_token', authToken);
  else localStorage.removeItem('notematica_auth_token');
}

function clearAuth() {
  setAuthToken('');
  currentProfile = null;
  updateAuthUi();
}

function updateAuthUi() {
  const user = document.getElementById('current-user');
  const logoutBtn = document.getElementById('logout-btn');
  if (currentProfile) {
    user.textContent = `Signed in: ${currentProfile.username}`;
    user.style.display = '';
    logoutBtn.style.display = '';
  } else {
    user.style.display = 'none';
    logoutBtn.style.display = 'none';
  }
}

function openAuthModal(mode, message = '') {
  authMode = mode;
  const title = document.getElementById('auth-title');
  const subtitle = document.getElementById('auth-subtitle');
  const submit = document.getElementById('auth-submit-btn');
  const err = document.getElementById('auth-error');
  const modal = document.getElementById('auth-modal');

  if (mode === 'bootstrap') {
    title.textContent = 'Create first account';
    subtitle.textContent = 'No user profiles exist yet. Create the first account to start using the app.';
    submit.textContent = 'Create account';
  } else {
    title.textContent = 'Sign in';
    subtitle.textContent = 'Enter your credentials to continue.';
    submit.textContent = 'Sign in';
  }
  err.textContent = message || '';
  document.getElementById('auth-password').value = '';
  modal.classList.add('open');
  setTimeout(() => document.getElementById('auth-username').focus(), 30);
}

function closeAuthModal() {
  document.getElementById('auth-modal').classList.remove('open');
  document.getElementById('auth-error').textContent = '';
}

async function ensureAuth() {
  const status = await api('GET', '/api/auth/status', null, { skipAuthRedirect: true });
  if (!status.hasProfiles) {
    openAuthModal('bootstrap');
    return false;
  }

  if (!authToken) {
    openAuthModal('login');
    return false;
  }

  try {
    const me = await api('GET', '/api/auth/me', null, { skipAuthRedirect: true });
    currentProfile = me.profile || null;
    if (!currentProfile) throw new Error('Invalid session');
    updateAuthUi();
    closeAuthModal();
    return true;
  } catch {
    clearAuth();
    openAuthModal('login');
    return false;
  }
}

async function submitAuth() {
  const username = document.getElementById('auth-username').value.trim();
  const password = document.getElementById('auth-password').value;
  const err = document.getElementById('auth-error');
  if (!username || !password) {
    err.textContent = 'Username and password are required.';
    return;
  }

  const path = authMode === 'bootstrap' ? '/api/auth/bootstrap' : '/api/auth/login';
  try {
    const out = await api('POST', path, { username, password }, { skipAuthRedirect: true });
    setAuthToken(out.token);
    currentProfile = out.profile || null;
    updateAuthUi();
    closeAuthModal();
    await Promise.all([loadNotebooks(), loadProfiles()]);
    showToast(authMode === 'bootstrap' ? '‚úÖ Account created and signed in' : '‚úÖ Signed in');
  } catch (e) {
    err.textContent = e.message;
  }
}

async function logout() {
  try {
    await api('POST', '/api/auth/logout', {}, { skipAuthRedirect: true });
  } catch (_) {}
  clearAuth();
  notebooks = [];
  sources = [];
  messages = [];
  notesList = [];
  profiles = [];
  renderNotebooks();
  renderSources();
  renderMessages();
  renderStudio();
  openAuthModal('login');
  showToast('Signed out');
}

// ‚îÄ‚îÄ‚îÄ Notebooks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadNotebooks() {
  try {
    notebooks = await api('GET', '/api/notebooks');
    if (notebooks.length > 0 && !activeNbId) activeNbId = notebooks[0].id;
    renderNotebooks();
    if (activeNbId) await loadNotebook(activeNbId);
  } catch (err) {
    if (/auth|session|required|credentials/i.test(String(err.message || ''))) return;
    showBanner('error', '‚ö†Ô∏è Could not connect to server. Make sure the server is running: npm start');
  }
}

async function loadNotebook(id) {
  activeNbId = id;
  const nb = notebooks.find(n => n.id === id);
  if (nb) document.getElementById('nb-title').textContent = nb.name;
  renderNotebooks();
  await Promise.all([loadSources(id), loadMessages(id), loadNotes(id)]);
  renderStudio();
}

async function loadSources(nbId) {
  try {
    sources = await api('GET', `/api/notebooks/${nbId}/sources`);
    renderSources();
  } catch(e) { console.error(e); }
}

async function loadMessages(nbId) {
  try {
    const msgs = await api('GET', `/api/notebooks/${nbId}/messages`);
    messages = msgs.map(m => ({ role: m.role === 'assistant' ? 'ai' : m.role, text: m.content, ts: formatTs(m.created_at) }));
    renderMessages();
  } catch(e) { console.error(e); }
}

async function loadNotes(nbId) {
  try {
    notesList = await api('GET', `/api/notebooks/${nbId}/notes`);
    if (studioTab === 'notes') renderStudio();
  } catch(e) { console.error(e); }
}

async function loadProfiles() {
  try {
    profiles = await api('GET', '/api/profiles');
    if (studioTab === 'profiles') renderStudio();
  } catch (e) {
    console.error(e);
  }
}

// ‚îÄ‚îÄ‚îÄ Renders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderNotebooks() {
  const el = document.getElementById('notebook-list');
  el.innerHTML = notebooks.map(nb => `
    <div class="nb-item ${nb.id === activeNbId ? 'active' : ''}" onclick="switchNb(${nb.id})">
      <span class="nb-icon">üìì</span>
      <span class="nb-name">${esc(nb.name)}</span>
      <span class="nb-badge">${nb.source_count || 0}</span>
    </div>`).join('');
}

function renderSources() {
  const el = document.getElementById('source-list');
  if (!sources.length) {
    el.innerHTML = `<div style="padding:12px 16px;font-size:12px;color:var(--text3);">No sources yet</div>`;
  } else {
    el.innerHTML = sources.map(s => `
      <div class="src-item">
        <span class="src-icon">${srcIcon(s.type)}</span>
        <span class="src-name" title="${esc(s.name)}">${esc(s.name)}</span>
        <button class="src-del" title="Remove source" onclick="deleteSource(${s.id},event)">‚úï</button>
      </div>`).join('');
  }
  const badgeArea = document.getElementById('badge-area');
  badgeArea.innerHTML = sources.slice(0,4).map(s =>
    `<span class="src-badge">${srcIcon(s.type)} ${esc(s.name.length > 22 ? s.name.slice(0,22)+'‚Ä¶' : s.name)}</span>`
  ).join('');
}

function renderMessages() {
  const el = document.getElementById('chat-messages');
  if (!messages.length) {
    el.innerHTML = `<div id="empty-state">
      <div class="es-icon">üí¨</div>
      <h3>Start a conversation</h3>
      <p>Ask anything about your sources. Notematica AI grounds its answers in the documents you've added.</p>
    </div>`;
    renderSuggestions();
    return;
  }
  el.innerHTML = messages.map(renderMsg).join('');
  el.scrollTop = el.scrollHeight;
  renderSuggestions();
}

function renderMsg(m) {
  const time = m.ts || '';
  if (m.role === 'user') {
    return `<div class="msg-row user"><div class="msg-avatar">üë§</div><div><div class="msg-bubble">${esc(m.text)}</div><div class="msg-time">${time}</div></div></div>`;
  }
  if (m.role === 'typing') {
    return `<div class="msg-row ai"><div class="msg-avatar">ü§ñ</div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  }
  return `<div class="msg-row ai"><div class="msg-avatar">ü§ñ</div><div><div class="msg-bubble">${mdToHtml(m.text)}</div><div class="msg-time">${time}</div></div></div>`;
}

function renderSuggestions() {
  const el = document.getElementById('suggestions');
  if (messages.length) { el.innerHTML = ''; return; }
  el.innerHTML = SUGGESTIONS.map(s =>
    `<div class="suggestion-chip" onclick="useSuggestion('${s}')">${s}</div>`
  ).join('');
}

function renderStudio() {
  const el = document.getElementById('studio-content');
  const nb = notebooks.find(n => n.id === activeNbId) || {};
  if (studioTab === 'studio') {
    el.innerHTML = `
      <div style="font-size:12px;color:var(--text3);margin-bottom:12px;">AI outputs for <strong style="color:var(--text2)">${esc(nb.name || '')}</strong></div>
      <div class="studio-card" onclick="useSuggestion('Summarize all sources in one paragraph')"><span class="card-icon">üìã</span><h4>Notebook Guide</h4><p>Structured summary of all sources with key themes and connections.</p></div>
      <div class="studio-card" onclick="useSuggestion('Generate a study guide with key terms and practice questions')"><span class="card-icon">üéì</span><h4>Study Guide</h4><p>Flashcards, key terms, and practice questions from your sources.</p></div>
      <div class="studio-card" onclick="useSuggestion('Create an executive briefing document from all sources')"><span class="card-icon">üì∞</span><h4>Briefing Doc</h4><p>Polished executive summary ready to share with stakeholders.</p></div>
      <div class="studio-card" onclick="useSuggestion('Extract all timeline events from my sources chronologically')"><span class="card-icon">üìÖ</span><h4>Timeline</h4><p>Chronological events extracted and organized from your sources.</p></div>
      <div class="studio-card" onclick="useSuggestion('Generate an FAQ with detailed answers based on my sources')"><span class="card-icon">‚ùì</span><h4>FAQ</h4><p>Frequently asked questions with grounded answers from sources.</p></div>`;
  } else if (studioTab === 'notes') {
    el.innerHTML = notesList.map(n => `
      <div class="note-item">
        <button class="note-del" onclick="deleteNote(${n.id})">‚úï</button>
        <div class="note-title">${esc(n.title)}</div>
        <div class="note-body">${esc(n.body)}</div>
        <div class="note-meta">${formatTs(n.created_at)}</div>
      </div>`).join('') +
      `<button class="add-note-btn" onclick="addNote()">Ôºã Add note</button>`;
  } else if (studioTab === 'mind') {
    el.innerHTML = `
      <div style="text-align:center;padding:24px 0;">
        <div style="font-size:40px;margin-bottom:12px;">üï∏</div>
        <div style="font-size:13px;color:var(--text2);margin-bottom:8px;">Mind Map</div>
        <div style="font-size:12px;color:var(--text3);">Concept map of your source connections</div>
        <button class="topbar-btn primary" style="margin:14px auto 0;display:inline-flex;" onclick="renderMindMap()">Generate</button>
      </div>
      <div id="mind-map-area"></div>`;
  } else if (studioTab === 'profiles') {
    el.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div style="font-size:12px;color:var(--text3);">Manage app user profiles</div>
        <button class="topbar-btn primary" onclick="createProfile()">Ôºã New</button>
      </div>
      ${profiles.length ? profiles.map(p => `
        <div class="note-item">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;">
            <div>
              <div class="note-title" style="margin:0;">${esc(p.username)}</div>
              <div class="note-meta">Created ${formatTs(p.created_at)}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="topbar-btn" onclick="editProfile(${p.id})">Edit username</button>
            <button class="topbar-btn" onclick="changeProfilePassword(${p.id})">Change password</button>
            <button class="topbar-btn" onclick="deleteProfile(${p.id})">Delete profile</button>
          </div>
        </div>`).join('') : '<div style="font-size:12px;color:var(--text3);padding:6px 0;">No profiles yet. Create one to add login credentials.</div>'}
    `;
  }
}

// ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function switchNb(id) {
  messages = []; sources = []; notesList = [];
  await loadNotebook(id);
}

function switchStudioTab(tab, el) {
  studioTab = tab;
  document.querySelectorAll('.studio-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  renderStudio();
}

function useSuggestion(text) {
  document.getElementById('chat-input').value = text;
  sendMessage();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text || !activeNbId) return;

  messages.push({ role: 'user', text, ts: nowStr() });
  input.value = '';
  autoResize();
  messages.push({ role: 'typing' });
  renderMessages();
  document.getElementById('send-btn').disabled = true;

  try {
    const { reply } = await api('POST', '/api/chat', { notebookId: activeNbId, message: text });
    messages.pop();
    messages.push({ role: 'ai', text: reply, ts: nowStr() });
  } catch (err) {
    messages.pop();
    messages.push({ role: 'ai', text: `‚ö†Ô∏è Error: ${err.message}`, ts: nowStr() });
  }
  renderMessages();
  document.getElementById('send-btn').disabled = false;
}

async function deleteSource(id, e) {
  e.stopPropagation();
  if (!confirm('Remove this source?')) return;
  await api('DELETE', `/api/notebooks/${activeNbId}/sources/${id}`);
  await loadSources(activeNbId);
  await loadNotebooks();
}

async function addNote() {
  const title = prompt('Note title:');
  if (!title) return;
  const body = prompt('Note content:');
  if (body === null) return;
  await api('POST', `/api/notebooks/${activeNbId}/notes`, { title, body });
  await loadNotes(activeNbId);
  renderStudio();
  showToast('Note saved!');
}

async function deleteNote(id) {
  await api('DELETE', `/api/notebooks/${activeNbId}/notes/${id}`);
  await loadNotes(activeNbId);
  renderStudio();
}

async function createProfile() {
  const username = prompt('Username (minimum 3 characters):');
  if (username === null) return;
  const password = prompt('Password (minimum 8 characters):');
  if (password === null) return;

  await api('POST', '/api/profiles', { username: username.trim(), password });
  await loadProfiles();
  showToast('‚úÖ Profile created');
}

async function editProfile(id) {
  const profile = profiles.find(p => p.id === id);
  if (!profile) return;
  const username = prompt('New username:', profile.username);
  if (username === null) return;

  await api('PATCH', `/api/profiles/${id}`, { username: username.trim() });
  await loadProfiles();
  showToast('‚úÖ Username updated');
}

async function changeProfilePassword(id) {
  const currentPassword = prompt('Current password:');
  if (currentPassword === null) return;
  const newPassword = prompt('New password (minimum 8 characters):');
  if (newPassword === null) return;

  await api('PATCH', `/api/profiles/${id}/password`, { currentPassword, newPassword });
  await loadProfiles();
  showToast('‚úÖ Password updated');
}

async function deleteProfile(id) {
  const profile = profiles.find(p => p.id === id);
  if (!profile) return;
  if (!confirm(`Delete profile "${profile.username}"?`)) return;

  const password = prompt('Enter current password to confirm delete:');
  if (password === null) return;

  await api('DELETE', `/api/profiles/${id}`, { password });
  await loadProfiles();
  showToast('‚úÖ Profile deleted');
}

function renderMindMap() {
  const el = document.getElementById('mind-map-area');
  const nodes = sources.slice(0,6).map(s => s.name.split('.')[0].slice(0,14));
  if (!nodes.length) { el.innerHTML = '<div style="font-size:12px;color:var(--text3);text-align:center;padding:8px;">Add sources first</div>'; return; }
  const nb = notebooks.find(n => n.id === activeNbId) || {};
  el.innerHTML = `
    <div style="font-size:11px;color:var(--text3);text-align:center;margin-bottom:8px;">Concept Map</div>
    <svg viewBox="0 0 220 220" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-height:200px;">
      <circle cx="110" cy="110" r="28" fill="rgba(124,106,247,0.25)" stroke="#7c6af7" stroke-width="1.5"/>
      <text x="110" y="114" text-anchor="middle" fill="#9c8fff" font-size="8">${esc((nb.name||'').slice(0,12))}</text>
      ${nodes.map((n,i)=>{const a=(i/nodes.length)*2*Math.PI-Math.PI/2;const x=110+78*Math.cos(a);const y=110+78*Math.sin(a);return`<line x1="110" y1="110" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}" stroke="#3d3d70" stroke-width="1"/><circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="20" fill="#1e1e3a" stroke="#3d3d70" stroke-width="1"/><text x="${x.toFixed(1)}" y="${(y+4).toFixed(1)}" text-anchor="middle" fill="#a0a0c0" font-size="6.5">${esc(n)}</text>`;}).join('')}
    </svg>`;
}

// ‚îÄ‚îÄ‚îÄ Upload modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openUploadModal() { document.getElementById('upload-modal').classList.add('open'); }
function closeUploadModal() {
  if (isRecording) stopLiveTranscript();
  document.getElementById('upload-modal').classList.remove('open');
  // Reset panels
  clearAudioFile(); clearVideoFile();
  document.getElementById('url-input').value = '';
  document.getElementById('text-input').value = '';
  document.getElementById('yt-url-input').value = '';
  document.getElementById('yt-preview-box').style.display = 'none';
  liveTranscriptText = '';
  const tout = document.getElementById('transcript-output');
  tout.textContent = 'Transcript will appear here as you speak‚Ä¶';
  tout.classList.add('empty');
  document.getElementById('live-transcript-box').style.display = 'none';
}

function switchUploadTab(tab, el) {
  if (uploadTab === 'audio' && isRecording) stopLiveTranscript();
  uploadTab = tab;
  document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  ['file','url','text','audio','video'].forEach(t => {
    const p = document.getElementById(`upload-${t}-panel`);
    if (p) p.style.display = t === tab ? '' : 'none';
  });
}

function handleFileDrop(event, kind) {
  event.preventDefault();
  event.currentTarget.classList.remove('dragover');
  const file = event.dataTransfer.files[0];
  if (!file) return;
  if (kind === 'audio') setAudioFile(file);
  else if (kind === 'video') setVideoFile(file);
  else uploadDocFile(file);
}

function handleDocFileSelect(e) {
  [...e.target.files].forEach(uploadDocFile);
  e.target.value = '';
}

async function uploadDocFile(file) {
  closeUploadModal();
  showToast(`Uploading ${file.name}‚Ä¶`);
  try {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('notebookId', activeNbId);
    await api('POST', '/api/sources/upload', fd);
    await loadSources(activeNbId);
    await loadNotebooks();
    showToast(`‚úÖ "${file.name}" added`);
  } catch (err) {
    showToast('‚ùå ' + err.message, true);
  }
}

async function confirmUpload() {
  const btn = document.getElementById('add-source-confirm-btn');
  btn.disabled = true;

  try {
    if (uploadTab === 'url') {
      const url = document.getElementById('url-input').value.trim();
      if (!url) { showToast('Please enter a URL'); btn.disabled = false; return; }
      showToast('Fetching URL‚Ä¶');
      await api('POST', '/api/sources/url', { notebookId: activeNbId, url });
      closeUploadModal();
      await loadSources(activeNbId); await loadNotebooks();
      showToast('‚úÖ URL source added');

    } else if (uploadTab === 'text') {
      const text = document.getElementById('text-input').value.trim();
      const name = document.getElementById('text-name-input').value.trim() || 'Pasted text';
      if (!text) { showToast('Please enter some text'); btn.disabled = false; return; }
      await api('POST', '/api/sources/text', { notebookId: activeNbId, name, text });
      closeUploadModal();
      await loadSources(activeNbId); await loadNotebooks();
      showToast('‚úÖ Text source added');

    } else if (uploadTab === 'audio') {
      if (liveTranscriptText.trim()) {
        const name = document.getElementById('audio-name-input').value.trim() || 'Live Transcript';
        stopLiveTranscript();
        await api('POST', '/api/sources/transcript', { notebookId: activeNbId, name, transcript: liveTranscriptText, type: 'audio' });
        closeUploadModal();
        await loadSources(activeNbId); await loadNotebooks();
        showToast('‚úÖ Live transcript saved');
      } else if (pendingAudioFile) {
        await transcribeAndSave(pendingAudioFile, 'audio');
      } else {
        showToast('Record audio or upload a file first');
        btn.disabled = false; return;
      }

    } else if (uploadTab === 'video') {
      const ytUrl = document.getElementById('yt-url-input').value.trim();
      const ytId = extractYouTubeId(ytUrl);
      if (ytId) {
        await fetchYouTubeTranscript(ytUrl);
      } else if (pendingVideoFile) {
        await transcribeAndSave(pendingVideoFile, 'video');
      } else {
        showToast('Paste a YouTube URL or upload a video file');
        btn.disabled = false; return;
      }
    }
  } catch (err) {
    showToast('‚ùå ' + err.message, true);
  }
  btn.disabled = false;
}

async function transcribeAndSave(file, type) {
  const proc = document.getElementById(type === 'audio' ? 'audio-processing' : 'video-processing');
  if (proc) proc.style.display = '';
  showToast(`Transcribing ${file.name} with Whisper‚Ä¶`);

  try {
    const fd = new FormData();
    fd.append('file', file);
    const { transcript, filename } = await api('POST', '/api/transcribe/file', fd);

    await api('POST', '/api/sources/transcript', {
      notebookId: activeNbId,
      name: filename || file.name,
      transcript,
      type
    });
    closeUploadModal();
    await loadSources(activeNbId); await loadNotebooks();
    showToast(`‚úÖ ${type === 'audio' ? 'Audio' : 'Video'} transcript saved`);
  } catch (err) {
    if (proc) proc.style.display = 'none';
    throw err;
  }
}

async function fetchYouTubeTranscript(url) {
  const proc = document.getElementById('yt-processing');
  if (proc) proc.style.display = '';
  showToast('Fetching YouTube transcript‚Ä¶');
  try {
    const { transcript, videoId } = await api('POST', '/api/transcribe/youtube', { url });
    const name = 'YouTube: ' + url.replace(/^https?:\/\/(www\.)?/, '').slice(0,50);
    await api('POST', '/api/sources/transcript', { notebookId: activeNbId, name, transcript, type: 'youtube' });
    closeUploadModal();
    await loadSources(activeNbId); await loadNotebooks();
    showToast('‚úÖ YouTube transcript saved');
  } catch (err) {
    if (proc) proc.style.display = 'none';
    throw err;
  }
}

// ‚îÄ‚îÄ‚îÄ Audio file helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleAudioFileSelect(e) { const f = e.target.files[0]; if (f) setAudioFile(f); e.target.value = ''; }
function handleVideoFileSelect(e) { const f = e.target.files[0]; if (f) setVideoFile(f); e.target.value = ''; }

function setAudioFile(file) {
  pendingAudioFile = file;
  document.getElementById('audio-file-name').textContent = file.name;
  document.getElementById('audio-file-size').textContent = fmtSize(file.size);
  document.getElementById('audio-file-info').style.display = '';
  document.getElementById('live-transcript-box').style.display = '';
  document.getElementById('audio-name-input').value = file.name.replace(/\.[^.]+$/,'');
}
function clearAudioFile() {
  pendingAudioFile = null;
  document.getElementById('audio-file-info').style.display = 'none';
  const inp = document.getElementById('audio-file-input');
  if (inp) inp.value = '';
}
function setVideoFile(file) {
  pendingVideoFile = file;
  document.getElementById('video-file-name').textContent = file.name;
  document.getElementById('video-file-size').textContent = fmtSize(file.size);
  document.getElementById('video-file-info').style.display = '';
}
function clearVideoFile() {
  pendingVideoFile = null;
  document.getElementById('video-file-info').style.display = 'none';
  const inp = document.getElementById('video-file-input');
  if (inp) inp.value = '';
}

// ‚îÄ‚îÄ‚îÄ Live transcript (Web Speech API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleLiveTranscript() {
  if (isRecording) stopLiveTranscript(); else startLiveTranscript();
}

function startLiveTranscript() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { showToast('Live transcript requires Chrome or Edge'); return; }
  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';
  recognition.onstart = () => setMicState(true);
  recognition.onresult = e => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) final += t + ' '; else interim += t;
    }
    if (final) liveTranscriptText += final;
    const box = document.getElementById('transcript-output');
    if (box) { box.classList.remove('empty'); box.innerHTML = esc(liveTranscriptText) + (interim ? `<span style="color:var(--text3)">${esc(interim)}</span>` : ''); box.scrollTop = box.scrollHeight; }
  };
  recognition.onerror = e => { showToast('Mic error: ' + e.error, true); setMicState(false); };
  recognition.onend = () => setMicState(false);
  recognition.start();
}

function stopLiveTranscript() {
  if (recognition) { try { recognition.stop(); } catch(e){} }
  setMicState(false);
}

function setMicState(on) {
  isRecording = on;
  const btn = document.getElementById('mic-btn');
  if (!btn) return;
  document.getElementById('mic-icon').textContent = on ? '‚èπ' : 'üé§';
  document.getElementById('mic-label').textContent = on ? 'Stop Recording' : 'Start Live Transcript';
  btn.classList.toggle('recording', on);
  const wf = document.getElementById('mic-waveform');
  if (wf) wf.style.display = on ? 'flex' : 'none';
  document.getElementById('live-transcript-box').style.display = on ? '' : (liveTranscriptText ? '' : 'none');
}

// ‚îÄ‚îÄ‚îÄ YouTube preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function extractYouTubeId(url) {
  const m = url.match(/(?:v=|youtu\.be\/|embed\/|shorts\/)([a-zA-Z0-9_-]{11})/);
  return m ? m[1] : null;
}
function previewYouTube(val) {
  const id = extractYouTubeId(val);
  const box = document.getElementById('yt-preview-box');
  if (!id) { box.style.display = 'none'; return; }
  box.style.display = '';
  document.getElementById('yt-thumb').innerHTML = `<img src="https://img.youtube.com/vi/${id}/mqdefault.jpg" onerror="this.parentElement.textContent='‚ñ∂'" alt="">`;
  document.getElementById('yt-meta').textContent = 'youtube.com/watch?v=' + id;
}

// ‚îÄ‚îÄ‚îÄ Notebook modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openNbModal() { document.getElementById('nb-modal').classList.add('open'); setTimeout(() => document.getElementById('nb-name-input').focus(), 50); }
function closeNbModal() { document.getElementById('nb-modal').classList.remove('open'); }

async function confirmNewNb() {
  const name = document.getElementById('nb-name-input').value.trim() || 'Untitled Notebook';
  document.getElementById('nb-name-input').value = '';
  closeNbModal();
  const nb = await api('POST', '/api/notebooks', { name });
  await loadNotebooks();
  await loadNotebook(nb.id);
}

// ‚îÄ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function srcIcon(type) {
  return { pdf:'üìÑ', txt:'üìù', url:'üîó', docx:'üìò', md:'üìã', audio:'üéµ', video:'üé¨', youtube:'‚ñ∂Ô∏è', csv:'üìä' }[type] || 'üìé';
}

function esc(s) {
  if (s == null) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function mdToHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^### (.+)$/gm, '<strong style="font-size:13px">$1</strong>')
    .replace(/^## (.+)$/gm, '<strong>$1</strong>')
    .replace(/^# (.+)$/gm, '<strong>$1</strong>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/^[-*] (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, s => `<ul>${s}</ul>`)
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^(.)/,'<p>$1').replace(/(.)$/,'$1</p>');
}

function showToast(msg, isErr = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = isErr ? 'show error-toast' : 'show';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.className = isErr ? 'error-toast' : ''; }, 3200);
}

function showBanner(type, msg) {
  const b = document.getElementById('status-banner');
  b.textContent = msg;
  b.className = type;
}

function nowStr() {
  const d = new Date();
  return 'Today, ' + d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
}

function formatTs(ts) {
  if (!ts) return '';
  const d = new Date(ts.includes('T') ? ts : ts + 'Z');
  return isNaN(d) ? '' : d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
}

function fmtSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

function autoResize() {
  const ta = document.getElementById('chat-input');
  ta.style.height = 'auto';
  ta.style.height = Math.min(ta.scrollHeight, 140) + 'px';
}

// ‚îÄ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('chat-input').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
document.getElementById('chat-input').addEventListener('input', autoResize);
document.getElementById('nb-name-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') confirmNewNb();
  if (e.key === 'Escape') closeNbModal();
});
document.getElementById('auth-password').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitAuth();
});
document.getElementById('auth-username').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitAuth();
});
['upload-modal','nb-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => {
    if (e.target.id === id) { if (id === 'upload-modal') closeUploadModal(); else closeNbModal(); }
  });
});

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
